<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food to Recipe - Inverse Cooking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#FF6B35',
                        'secondary': '#F7931E',
                        'accent': '#FFE5D9',
                        'success': '#10B981',
                        'warning': '#F59E0B'
                    }
                }
            }
        }
    </script>
    <style>
        .ingredients-box {
            line-height: 2.5;
        }
        mark {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        mark a {
            color: inherit;
            text-decoration: none;
        }
        .list-group-item {
            border-left: none;
            border-right: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-white to-amber-50 min-h-screen">
   
    {% include 'navbar.html' %}

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="max-w-2xl mx-auto mb-6">
                        <div class="alert alert-{{ category }} flash-message {{ category }} p-4 rounded-lg {% if category == 'error' %}bg-red-100 border border-red-400 text-red-700{% elif category == 'success' %}bg-green-100 border border-green-400 text-green-700{% else %}bg-blue-100 border border-blue-400 text-blue-700{% endif %}">
                            <div class="flex items-center">
                                <i class="fas {% if category == 'error' %}fa-exclamation-triangle{% elif category == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} mr-2"></i>
                                <span>{{ message }}</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Upload Section -->
        <div class="max-w-2xl mx-auto mb-12">
            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 p-8 md:p-10">
                <div class="text-center mb-8">
                    <div class="bg-gradient-to-r from-primary to-secondary w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-camera text-white text-2xl"></i>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">Upload Food Image</h1>
                    <p class="text-lg text-gray-600">Discover recipes from your food photos with AI-powered analysis</p>
                </div>

                <form method="POST" enctype="multipart/form-data" action="{{ url_for('predict') }}" class="space-y-6" id="upload-form">
                    <!-- File Upload Area -->
                    <div class="relative">
                        <div class="border-3 border-dashed border-gray-300 rounded-2xl p-12 text-center bg-gray-50/50 hover:bg-accent/30 hover:border-primary/50 transition-all duration-300 cursor-pointer" id="upload-area">
                            <div class="space-y-4">
                                <div class="bg-primary/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                                    <i class="fas fa-cloud-upload-alt text-primary text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-lg font-semibold text-gray-700 mb-2" id="upload-text">
                                        Click to upload your food image
                                    </p>
                                    <p class="text-gray-500 mb-4">or drag and drop</p>
                                </div>
                            </div>
                        </div>
                        <input type="file" 
                               name="image" 
                               accept="image/*" 
                               required 
                               class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                               id="file-input">
                    </div>

                    <!-- Error Message Display -->
                    <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-xl p-4">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                            <div class="text-sm text-red-700">
                                <p class="font-medium mb-1" id="error-title">Upload Error</p>
                                <p id="error-description">Please try again with a valid food image.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Success Message Display -->
                    <div id="success-message" class="hidden bg-green-50 border border-green-200 rounded-xl p-4">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-check-circle text-green-500 mt-1"></i>
                            <div class="text-sm text-green-700">
                                <p class="font-medium mb-1">Valid Food Image</p>
                                <p id="success-description">Image uploaded successfully! Ready to analyze.</p>
                            </div>
                        </div>
                    </div>

                    <!-- File Requirements -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                            <div class="text-sm text-blue-700">
                                <p class="font-medium mb-1">For best results:</p>
                                <ul class="list-disc list-inside space-y-1 text-blue-600">
                                    <li>Use clear, well-lit photos of food dishes</li>
                                    <li>Focus on the main dish (avoid people, objects, or non-food items)</li>
                                    <li>Ensure the image is sharp and not blurry</li>
                                    <li>Supported formats: JPG, PNG, WebP</li>
                                    <li>Maximum file size: 10MB</li>
                                    <li>Only food images are accepted - non-food images will be rejected</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-primary to-secondary text-white text-lg font-semibold py-4 px-8 rounded-2xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                        <i class="fas fa-magic mr-3"></i>
                        Analyze & Get Recipe
                    </button>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        {% if prediction %}
        <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 p-8 mb-8">
            <!-- Recipe Header -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                <div>
                    <h1 id="recipe-name" class="text-4xl font-bold text-gray-900 mb-2">{{ prediction.recipe_name }}</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Favorite Button -->
                    <button id="favorite-btn" onclick="toggleFavorite()" class="bg-white/90 backdrop-blur-sm border border-gray-200 text-gray-700 px-6 py-3 rounded-xl font-medium hover:bg-white transition-all transform hover:-translate-y-0.5 shadow-lg hover:shadow-xl">
                        <i id="favorite-icon" class="far fa-heart mr-2"></i>
                        <span id="favorite-text">Add to Favorites</span>
                    </button>
                    
                    <!-- Confidence Score -->
                    <!-- <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full flex items-center space-x-2">
                        <i class="fas fa-check-circle"></i>
                        <span class="font-semibold">Confidence: {{ prediction.score }}</span>
                    </div> -->
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Left Column - Image & Quick Info -->
                <div class="space-y-6">
                    <!-- Uploaded Image -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 overflow-hidden">
                        <img src="{{ url_for('uploaded_file', filename=prediction.image_filename) }}" 
                             alt="{{ prediction.recipe_name }}" class="w-full h-64 object-cover">
                    </div>

                    <!-- Nutritional Info
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 p-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-heartbeat text-red-500 mr-3"></i>
                            Nutritional Facts
                        </h3>
                        <div class="space-y-4">
                            {{ prediction.nutritional_facts }}
                        </div>
                    </div> -->
                </div>

                <!-- Right Column - Recipe Details -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Voice Assistant Controls -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20">
                        <div class="bg-gradient-to-r from-primary to-secondary p-6 rounded-t-3xl">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <h2 class="text-2xl font-bold text-white flex items-center">
                                    <i class="fas fa-microphone mr-3"></i>
                                    Voice Assistant
                                </h2>
                                <div class="flex items-center gap-3">
                                    <label for="voice-lang" class="text-white font-medium">Language</label>
                                    <select id="voice-lang" class="bg-white/90 text-gray-900 px-3 py-2 rounded-lg">
                                        <option value="en-US">English (US)</option>
                                        <option value="en-GB">English (UK)</option>
                                        <option value="hi-IN">Hindi (India)</option>
                                        <option value="te-IN">Telugu (India)</option>
                                        <option value="ta-IN">Tamil (India)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="grid md:grid-cols-3 gap-4">
                                <div class="space-y-2">
                                    <div class="text-sm font-semibold text-gray-600">Recipe</div>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="btn-speak-name" class="px-4 py-2 rounded-xl bg-primary text-white hover:opacity-90">
                                            <i class="fas fa-volume-up mr-2"></i>Read Recipe Name
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="text-sm font-semibold text-gray-600">Ingredients</div>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="btn-speak-ingredients" class="px-4 py-2 rounded-xl bg-secondary text-white hover:opacity-90">
                                            <i class="fas fa-list-ul mr-2"></i>Read Ingredients
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="text-sm font-semibold text-gray-600">Instructions</div>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="btn-start-steps" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:opacity-90">
                                            <i class="fas fa-play mr-2"></i>Start
                                        </button>
                                        <button id="btn-prev-step" class="px-4 py-2 rounded-xl bg-amber-600 text-white hover:opacity-90">
                                            <i class="fas fa-step-backward mr-2"></i>Back
                                        </button>
                                        <button id="btn-next-step" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:opacity-90">
                                            <i class="fas fa-step-forward mr-2"></i>Next
                                        </button>
                                        <button id="btn-repeat-step" class="px-4 py-2 rounded-xl bg-fuchsia-600 text-white hover:opacity-90">
                                            <i class="fas fa-redo mr-2"></i>Repeat
                                        </button>
                                        <button id="btn-stop" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:opacity-90">
                                            <i class="fas fa-stop mr-2"></i>Stop
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex flex-col gap-2">
                                <div id="voice-status" class="text-sm text-gray-600"></div>
                                <div class="text-xs text-gray-500">Note: Basic translation available for Hindi, Telugu, and Tamil. Only the voice output will be translated, the displayed text remains in English.</div>
                            </div>
                        </div>
                    </div>
                    <!-- Ingredients Section -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20">
                        <div class="bg-gradient-to-r from-primary to-secondary p-6 rounded-t-3xl">
                            <h2 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-list-ul mr-3"></i>
                                Ingredients
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="ingredients-box" id="ingredients-box">
                                {{ prediction.highlighted_ingredients|safe }}
                            </div>
                            <div id="ingredients-raw" class="hidden">{{ prediction.ingredients_raw }}</div>
                        </div>
                    </div>

                    <!-- Instructions Section -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20">
                        <div class="bg-gradient-to-r from-primary to-secondary p-6 rounded-t-3xl">
                            <h2 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-list-ol mr-3"></i>
                                Instructions
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4" id="instructions-list">
                                {% for instruction in prediction.recipe.split('\n') %}
                                {% if instruction.strip() %}
                                <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-xl hover:bg-accent/20 transition-colors">
                                    <div class="bg-gradient-to-r from-primary to-secondary text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0">
                                        {{ loop.index }}
                                    </div>
                                    <p class="text-gray-700 leading-relaxed">
                                        {{ instruction }}
                                    </p>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <div id="instructions-json" class="hidden">{{ prediction.instructions_list|tojson }}</div>
                        </div>
                    </div>

                    <!-- Recipe Rating & Feedback Section -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20">
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 rounded-t-3xl">
                            <h2 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-star mr-3"></i>
                                Rate This Recipe
                            </h2>
                        </div>
                        <div class="p-6">
                            <!-- Overall Rating -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Overall Rating *</label>
                                <div class="flex space-x-1" id="overall-rating">
                                    <button type="button" class="rating-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="1">★</button>
                                    <button type="button" class="rating-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="2">★</button>
                                    <button type="button" class="rating-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="3">★</button>
                                    <button type="button" class="rating-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="4">★</button>
                                    <button type="button" class="rating-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="5">★</button>
                                </div>
                            </div>
                            
                            <!-- Detailed Ratings -->
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <!-- Taste Rating -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Taste Rating</label>
                                    <div class="flex space-x-1" id="taste-rating">
                                        <button type="button" class="taste-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="1">★</button>
                                        <button type="button" class="taste-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="2">★</button>
                                        <button type="button" class="taste-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="3">★</button>
                                        <button type="button" class="taste-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="4">★</button>
                                        <button type="button" class="taste-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="5">★</button>
                                    </div>
                                </div>
                                
                                <!-- Presentation Rating -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Presentation Rating</label>
                                    <div class="flex space-x-1" id="presentation-rating">
                                        <button type="button" class="presentation-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="1">★</button>
                                        <button type="button" class="presentation-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="2">★</button>
                                        <button type="button" class="presentation-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="3">★</button>
                                        <button type="button" class="presentation-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="4">★</button>
                                        <button type="button" class="presentation-star text-2xl text-gray-300 hover:text-yellow-400" data-rating="5">★</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional Fields -->
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cooking Experience</label>
                                    <select id="cooking-experience" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="easy">Easy</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="flex items-center mt-6">
                                        <input type="checkbox" id="would-cook-again" class="mr-2 text-primary focus:ring-primary" checked>
                                        <span class="text-sm text-gray-700">I would cook this recipe again</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Feedback Text -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Your Feedback (Optional)</label>
                                <textarea id="feedback-text" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Share your cooking experience, tips, or suggestions..."></textarea>
                            </div>
                            
                            <!-- Submit Rating Button -->
                            <button id="submit-rating" class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-6 py-3 rounded-xl font-medium hover:from-emerald-600 hover:to-teal-700 transition-all transform hover:-translate-y-0.5 shadow-lg hover:shadow-xl">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Submit Rating
                            </button>
                            
                            <!-- Recipe Statistics -->
                            <!-- <div id="recipe-stats" class="hidden mt-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3">Recipe Statistics</h3>
                                <div class="grid md:grid-cols-3 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-primary" id="avg-rating">-</div>
                                        <div class="text-sm text-gray-600">Average Rating</div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-secondary" id="total-ratings">-</div>
                                        <div class="text-sm text-gray-600">Total Ratings</div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-emerald-600" id="would-cook-again-percent">-</div>
                                        <div class="text-sm text-gray-600">Would Cook Again</div>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                    </div>

                    <!-- Recipe Sharing Section -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 rounded-t-3xl">
                            <h2 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-share-alt mr-3"></i>
                                Share This Recipe
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- Social Media Sharing -->
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Share on Social Media</h3>
                                    <div class="space-y-3">
                                        <button onclick="shareRecipe('social_media')" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                                            <i class="fab fa-facebook mr-2"></i>
                                            Share on Facebook
                                        </button>
                                        <button onclick="shareRecipe('whatsapp')" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                                            <i class="fab fa-whatsapp mr-2"></i>
                                            Share on WhatsApp
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Other Sharing Options -->
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Other Options</h3>
                                    <div class="space-y-3">
                                        <button onclick="shareRecipe('email')" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
                                            <i class="fas fa-envelope mr-2"></i>
                                            Share via Email
                                        </button>
                                        <button onclick="copyRecipeLink()" class="w-full bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center">
                                            <i class="fas fa-link mr-2"></i>
                                            Copy Recipe Link
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="share-status" class="mt-4 text-sm text-green-600 text-center"></div>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-6 rounded-t-3xl">
                            <h2 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-comments mr-3"></i>
                                Community Comments
                            </h2>
                        </div>
                        <div class="p-6">
                            <!-- Add Comment -->
                            <div class="mb-6">
                                <textarea id="comment-text" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent mb-3" placeholder="Share your thoughts about this recipe..."></textarea>
                                <div class="flex items-center justify-between">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="comment-public" class="mr-2 text-primary focus:ring-primary" checked>
                                        <span class="text-sm text-gray-700">Make comment public</span>
                                    </label>
                                    <button id="submit-comment" class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-pink-700 transition-all">
                                        <i class="fas fa-paper-plane mr-2"></i>
                                        Post Comment
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Comments List -->
                            <div id="comments-list" class="space-y-4">
                                <!-- Comments will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Source Section
                    {% if prediction.source %}
                    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 p-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-external-link-alt text-blue-500 mr-3"></i>
                            Recipe Source
                        </h3>
                        <p class="text-gray-600 mb-4">Want to explore more variations of this recipe?</p>
                        <a href="{{ prediction.source }}" target="_blank" 
                           class="inline-flex items-center space-x-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl font-medium hover:from-blue-600 hover:to-blue-700 transition-all transform hover:-translate-y-0.5 shadow-lg hover:shadow-xl">
                            <i class="fas fa-globe"></i>
                            <span>View Original Recipe</span>
                            <i class="fas fa-external-link-alt text-sm"></i>
                        </a>
                    </div>
                    {% endif %} -->
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // Enhanced file upload validation and feedback
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.getElementById('upload-area');
            const uploadText = document.getElementById('upload-text');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            const errorTitle = document.getElementById('error-title');
            const errorDescription = document.getElementById('error-description');
            const successDescription = document.getElementById('success-description');

            // File validation function
            function validateFile(file) {
                const maxSize = 10 * 1024 * 1024; // 10MB
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                
                // Check file size
                if (file.size > maxSize) {
                    return {
                        valid: false,
                        message: 'File size too large. Please upload an image smaller than 10MB.'
                    };
                }
                
                // Check file type
                if (!allowedTypes.includes(file.type)) {
                    return {
                        valid: false,
                        message: 'Invalid file type. Please upload JPG, PNG, or WebP images only.'
                    };
                }
                
                return { valid: true };
            }

            // Show error message
            function showError(title, description) {
                errorTitle.textContent = title;
                errorDescription.textContent = description;
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                uploadArea.classList.add('border-red-300', 'bg-red-50/30');
                uploadArea.classList.remove('border-gray-300', 'bg-gray-50/50');
            }

            // Show success message
            function showSuccess(description) {
                successDescription.textContent = description;
                successMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                uploadArea.classList.remove('border-red-300', 'bg-red-50/30');
                uploadArea.classList.add('border-green-300', 'bg-green-50/30');
            }

            // Reset upload area
            function resetUploadArea() {
                uploadArea.classList.remove('border-red-300', 'bg-red-50/30', 'border-green-300', 'bg-green-50/30');
                uploadArea.classList.add('border-gray-300', 'bg-gray-50/50');
                errorMessage.classList.add('hidden');
                successMessage.classList.add('hidden');
            }

            // File input change handler
            fileInput.addEventListener('change', function(e) {
                const file = this.files[0];
                if (!file) {
                    resetUploadArea();
                    uploadText.textContent = 'Click to upload your food image';
                    return;
                }

                // Validate file
                const validation = validateFile(file);
                if (!validation.valid) {
                    showError('Invalid File', validation.message);
                    uploadText.textContent = 'Click to upload your food image';
                    this.value = ''; // Clear the input
                    return;
                }

                // Show success for valid file
                uploadText.textContent = `Selected: ${file.name}`;
                showSuccess('Image uploaded successfully! Ready to analyze.');
            });

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-primary/50', 'bg-accent/30');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('border-primary/50', 'bg-accent/30');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-primary/50', 'bg-accent/30');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });

        });
    </script>

    <!-- Flash Messages Handler -->
    <script>
        // Handle flash messages from server
        document.addEventListener('DOMContentLoaded', function() {
            // Check for flash messages
            const flashMessages = document.querySelectorAll('.alert, .flash-message');
            flashMessages.forEach(function(message) {
                if (message.classList.contains('alert-error') || message.classList.contains('error')) {
                    if (typeof showError === 'function') {
                        showError('Upload Error', message.textContent);
                    }
                } else if (message.classList.contains('alert-success') || message.classList.contains('success')) {
                    if (typeof showSuccess === 'function') {
                        showSuccess(message.textContent);
                    }
                }
            });
        });
    </script>

    <script>
        // Voice Assistant using Web Speech API + backend translation
        (function(){
            if (!('speechSynthesis' in window)) {
                return;
            }

            const status = document.getElementById('voice-status');
            const langSelect = document.getElementById('voice-lang');
            const speakBtnName = document.getElementById('btn-speak-name');
            const speakBtnIngr = document.getElementById('btn-speak-ingredients');
            const startBtn = document.getElementById('btn-start-steps');
            const nextBtn = document.getElementById('btn-next-step');
            const prevBtn = document.getElementById('btn-prev-step');
            const repeatBtn = document.getElementById('btn-repeat-step');
            const stopBtn = document.getElementById('btn-stop');

            // Elements containing content
            const recipeNameEl = document.getElementById('recipe-name');
            const ingredientsBox = document.getElementById('ingredients-box');
            const instructionsList = document.getElementById('instructions-list');

            if (!langSelect || !recipeNameEl || !ingredientsBox || !instructionsList) {
                return;
            }

            let voices = [];
            let currentStepIndex = 0;
            let steps = [];
            let translatedContent = null;
            let original = {
                title: (document.getElementById('recipe-name')||{}).innerText || '',
                ingredients: (document.getElementById('ingredients-raw')||{}).innerText || '',
                steps: []
            };

            function populateVoices() {
                voices = window.speechSynthesis.getVoices();
            }
            populateVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoices;
            }

            function speak(text) {
                window.speechSynthesis.cancel();
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = langSelect.value;
                // try to pick a matching voice
                const v = voices.find(v => v.lang === utter.lang) || voices.find(v => v.lang.startsWith(utter.lang.split('-')[0])) || null;
                if (v) utter.voice = v;
                window.speechSynthesis.speak(utter);
            }

            function getPlainTextFromHTML(el) {
                const tmp = el.cloneNode(true);
                // remove links markup from highlighted ingredients
                tmp.querySelectorAll('a').forEach(a=>a.replaceWith(a.textContent));
                return tmp.innerText.replace(/\s+/g,' ').trim();
            }

            function extractSteps() {
                // Prefer server-provided list for clean text
                try {
                    const raw = document.getElementById('instructions-json');
                    if (raw && raw.textContent) {
                        original.steps = JSON.parse(raw.textContent);
                    }
                } catch(e) {}
                if (!original.steps || !original.steps.length) {
                    original.steps = Array.from(instructionsList.querySelectorAll('p')).map(p=>p.innerText.trim()).filter(Boolean);
                }
                steps = original.steps.slice();
            }
            extractSteps();

            async function translateAll(targetLang){
                const payload = {
                    lang: targetLang,
                    title: original.title,
                    ingredients: original.ingredients,
                    steps: original.steps
                };
                const res = await fetch('/translate',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(!data.ok){ throw new Error(data.error||'Translation failed'); }
                // Store translated content for voice only, don't update UI
                translatedContent = {
                    title: data.title || original.title,
                    ingredients: data.ingredients || original.ingredients,
                    steps: data.steps || original.steps
                };
            }

            // Translate when language changes (and also change voice)
            if (langSelect){
                langSelect.addEventListener('change', async ()=>{
                    status && (status.textContent = 'Translating for voice...');
                    try{
                        const lang = langSelect.value;
                        if (lang === 'en-US' || lang === 'en-GB') {
                            // Reset to English - no translation needed
                            translatedContent = null;
                            status && (status.textContent = 'Voice will use English.');
                        } else {
                            await translateAll(lang);
                            status && (status.textContent = 'Translated for voice. You can start listening.');
                        }
                    }catch(e){
                        status && (status.textContent = 'Translation not available.');
                    }
                });
            }

            // Button bindings
            if (speakBtnName) speakBtnName.onclick = () => {
                const titleToSpeak = translatedContent ? translatedContent.title : recipeNameEl.innerText;
                speak(`Recipe name. ${titleToSpeak}`);
                status && (status.textContent = 'Reading recipe name...');
            };
            if (speakBtnIngr) speakBtnIngr.onclick = () => {
                const ingredientsToSpeak = translatedContent ? translatedContent.ingredients : getPlainTextFromHTML(ingredientsBox);
                speak(`Ingredients. ${ingredientsToSpeak}`);
                status && (status.textContent = 'Reading ingredients...');
            };
            if (startBtn) startBtn.onclick = () => {
                currentStepIndex = 0;
                if (!steps.length) extractSteps();
                if (steps.length) {
                    const stepToSpeak = translatedContent && translatedContent.steps.length > 0 ? translatedContent.steps[0] : steps[0];
                    speak(`Step 1. ${stepToSpeak}`);
                    status && (status.textContent = `Reading step 1 of ${steps.length}...`);
                }
            };
            if (nextBtn) nextBtn.onclick = () => {
                if (!steps.length) return;
                currentStepIndex = Math.min(currentStepIndex + 1, steps.length - 1);
                const stepToSpeak = translatedContent && translatedContent.steps.length > currentStepIndex ? translatedContent.steps[currentStepIndex] : steps[currentStepIndex];
                speak(`Step ${currentStepIndex+1}. ${stepToSpeak}`);
                status && (status.textContent = `Reading step ${currentStepIndex+1} of ${steps.length}...`);
            };
            if (prevBtn) prevBtn.onclick = () => {
                if (!steps.length) return;
                currentStepIndex = Math.max(currentStepIndex - 1, 0);
                const stepToSpeak = translatedContent && translatedContent.steps.length > currentStepIndex ? translatedContent.steps[currentStepIndex] : steps[currentStepIndex];
                speak(`Step ${currentStepIndex+1}. ${stepToSpeak}`);
                status && (status.textContent = `Reading step ${currentStepIndex+1} of ${steps.length}...`);
            };
            if (repeatBtn) repeatBtn.onclick = () => {
                if (!steps.length) return;
                const stepToSpeak = translatedContent && translatedContent.steps.length > currentStepIndex ? translatedContent.steps[currentStepIndex] : steps[currentStepIndex];
                speak(`Step ${currentStepIndex+1}. ${stepToSpeak}`);
                status && (status.textContent = `Repeating step ${currentStepIndex+1}...`);
            };
            if (stopBtn) stopBtn.onclick = () => {
                window.speechSynthesis.cancel();
                status && (status.textContent = 'Stopped speaking.');
            };
        })();

        // Recipe Rating System
        (function() {
            let currentRatings = {
                overall: 0,
                taste: 0,
                presentation: 0
            };

            // Initialize rating stars
            function initializeRatingStars() {
                // Handle overall rating
                const overallContainer = document.getElementById('overall-rating');
                if (overallContainer) {
                    const stars = overallContainer.querySelectorAll('.rating-star');
                    stars.forEach(star => {
                        star.addEventListener('click', () => {
                            const rating = parseInt(star.dataset.rating);
                            setRating('overall', rating);
                        });
                    });
                }
                
                // Handle taste rating
                const tasteContainer = document.getElementById('taste-rating');
                if (tasteContainer) {
                    const stars = tasteContainer.querySelectorAll('.taste-star');
                    stars.forEach(star => {
                        star.addEventListener('click', () => {
                            const rating = parseInt(star.dataset.rating);
                            setRating('taste', rating);
                        });
                    });
                }
                
                // Handle presentation rating
                const presentationContainer = document.getElementById('presentation-rating');
                if (presentationContainer) {
                    const stars = presentationContainer.querySelectorAll('.presentation-star');
                    stars.forEach(star => {
                        star.addEventListener('click', () => {
                            const rating = parseInt(star.dataset.rating);
                            setRating('presentation', rating);
                        });
                    });
                }
            }

            function setRating(type, rating) {
                currentRatings[type] = rating;
                updateStarDisplay(type, rating);
            }

            function updateStarDisplay(type, rating) {
                const container = document.getElementById(`${type}-rating`);
                if (!container) return;
                
                const stars = container.querySelectorAll('.rating-star, .taste-star, .presentation-star');
                stars.forEach((star, index) => {
                    const starRating = index + 1;
                    if (starRating <= rating) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-yellow-400');
                    } else {
                        star.classList.remove('text-yellow-400');
                        star.classList.add('text-gray-300');
                    }
                });
            }

            // Submit rating
            document.getElementById('submit-rating')?.addEventListener('click', async () => {
                if (currentRatings.overall === 0) {
                    alert('Please provide an overall rating');
                    return;
                }

                const ratingData = {
                    food_name: document.getElementById('recipe-name').innerText,
                    rating: currentRatings.overall,
                    taste_rating: currentRatings.taste || currentRatings.overall,
                    presentation_rating: currentRatings.presentation || currentRatings.overall,
                    cooking_experience: document.getElementById('cooking-experience').value,
                    feedback_text: document.getElementById('feedback-text').value,
                    would_cook_again: document.getElementById('would-cook-again').checked
                };

                try {
                    const response = await fetch('/rate_recipe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ratingData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert('Rating submitted successfully!');
                        loadRecipeStats();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Failed to submit rating');
                    console.error(error);
                }
            });

            // Load recipe statistics
            async function loadRecipeStats() {
                try {
                    const foodName = document.getElementById('recipe-name').innerText;
                    const response = await fetch(`/get_recipe_stats/${encodeURIComponent(foodName)}`);
                    const data = await response.json();
                    
                    if (data.stats) {
                        displayRecipeStats(data.stats);
                        document.getElementById('recipe-stats').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Failed to load recipe stats:', error);
                }
            }

            function displayRecipeStats(stats) {
                if (stats.avg_rating) {
                    document.getElementById('avg-rating').textContent = stats.avg_rating.toFixed(1);
                }
                if (stats.total_ratings) {
                    document.getElementById('total-ratings').textContent = stats.total_ratings;
                }
                if (stats.total_ratings && stats.would_cook_again_count) {
                    const percentage = ((stats.would_cook_again_count / stats.total_ratings) * 100).toFixed(0);
                    document.getElementById('would-cook-again-percent').textContent = percentage + '%';
                }
            }

            // Initialize
            initializeRatingStars();
            loadRecipeStats();
        })();

        // Recipe Sharing System
        async function shareRecipe(shareType) {
            const foodName = document.getElementById('recipe-name').innerText;
            const shareData = {
                food_name: foodName,
                share_type: shareType,
                share_data: {
                    timestamp: new Date().toISOString(),
                    user_agent: navigator.userAgent
                }
            };

            try {
                const response = await fetch('/share_recipe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(shareData)
                });

                const result = await response.json();
                if (result.success) {
                    // Open sharing URLs
                    if (shareType === 'social_media') {
                        // Open social media sharing in new windows
                        if (result.share_urls.facebook) {
                            window.open(result.share_urls.facebook, '_blank', 'width=600,height=400');
                        }
                    } else if (shareType === 'whatsapp' && result.share_urls.whatsapp) {
                        window.open(result.share_urls.whatsapp, '_blank');
                    } else if (shareType === 'email' && result.share_urls.email) {
                        window.open(result.share_urls.email, '_blank');
                    }
                    
                    document.getElementById('share-status').textContent = result.message;
                    setTimeout(() => {
                        document.getElementById('share-status').textContent = '';
                    }, 3000);
                }
            } catch (error) {
                console.error('Failed to share recipe:', error);
                document.getElementById('share-status').textContent = 'Failed to share recipe';
            }
        }

        function copyRecipeLink() {
            const foodName = document.getElementById('recipe-name').innerText;
            const recipeUrl = `${window.location.origin}/recipe/${foodName.replace(/ /g, '_')}`;
            
            navigator.clipboard.writeText(recipeUrl).then(() => {
                document.getElementById('share-status').textContent = 'Recipe link copied to clipboard!';
                setTimeout(() => {
                    document.getElementById('share-status').textContent = '';
                }, 3000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = recipeUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                document.getElementById('share-status').textContent = 'Recipe link copied to clipboard!';
                setTimeout(() => {
                    document.getElementById('share-status').textContent = '';
                }, 3000);
            });
        }

        // Comments System
        (function() {
            let currentComments = [];
            let commentPage = 0;

            // Submit comment
            document.getElementById('submit-comment')?.addEventListener('click', async () => {
                const commentText = document.getElementById('comment-text').value.trim();
                const isPublic = document.getElementById('comment-public').checked;
                
                if (!commentText) {
                    alert('Please enter a comment');
                    return;
                }

                const commentData = {
                    food_name: document.getElementById('recipe-name').innerText,
                    comment_text: commentText,
                    is_public: isPublic
                };

                try {
                    const response = await fetch('/add_comment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(commentData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('comment-text').value = '';
                        alert('Comment posted successfully!');
                        loadComments();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Failed to post comment');
                    console.error(error);
                }
            });

            // Load comments
            async function loadComments() {
                try {
                    const foodName = document.getElementById('recipe-name').innerText;
                    const response = await fetch(`/get_recipe_comments/${encodeURIComponent(foodName)}`);
                    const data = await response.json();
                    
                    if (data.comments) {
                        currentComments = data.comments;
                        displayComments(data.comments);
                    }
                } catch (error) {
                    console.error('Failed to load comments:', error);
                }
            }

            function displayComments(comments) {
                const container = document.getElementById('comments-list');
                if (!container) return;

                if (comments.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No comments yet. Be the first to share your thoughts!</p>';
                    return;
                }

                container.innerHTML = comments.map(comment => `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                            <div class="font-medium text-gray-900">${comment.user_name}</div>
                            <div class="text-sm text-gray-500">${new Date(comment.created_at).toLocaleDateString()}</div>
                        </div>
                        <p class="text-gray-700">${comment.comment_text}</p>
                    </div>
                `).join('');
            }

            // Initialize
            loadComments();
        })();

        // Favorite System
        (function() {
            let isFavorited = false;
            
            // Check if recipe is already favorited
            async function checkFavoriteStatus() {
                try {
                    const foodName = document.getElementById('recipe-name').innerText;
                    console.log('Checking favorite status for:', foodName); // Debug log
                    
                    // First, check if user is logged in
                    const sessionResponse = await fetch('/test_session');
                    const sessionData = await sessionResponse.json();
                    
                    if (!sessionData.loggedin) {
                        console.log('User not logged in, hiding favorite button');
                        const btn = document.getElementById('favorite-btn');
                        if (btn) btn.style.display = 'none';
                        return;
                    }
                    
                    // Now check favorite status using the simpler route
                    const response = await fetch(`/is_favorited/${encodeURIComponent(foodName)}`);
                    const result = await response.json();
                    console.log('Favorite status result:', result); // Debug log
                    
                    if (result.is_favorited !== undefined) {
                        isFavorited = result.is_favorited;
                        updateFavoriteButton();
                    } else {
                        console.error('Failed to get favorite status:', result.error);
                        // Show error state
                        const text = document.getElementById('favorite-text');
                        if (text) text.textContent = 'Error loading';
                    }
                } catch (error) {
                    console.error('Failed to check favorite status:', error);
                    // Show error state
                    const text = document.getElementById('favorite-text');
                    if (text) text.textContent = 'Error loading';
                }
            }
            
            // Toggle favorite
            window.toggleFavorite = async function() {
                try {
                    const foodName = document.getElementById('recipe-name').innerText;
                    console.log('Toggling favorite for:', foodName); // Debug log
                    
                    const response = await fetch('/toggle_favorite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ food_name: foodName, action: 'toggle' })
                    });
                    
                    const result = await response.json();
                    console.log('Toggle favorite result:', result); // Debug log
                    
                    if (result.success) {
                        isFavorited = result.is_favorited;
                        updateFavoriteButton();
                        
                        // Show feedback
                        const btn = document.getElementById('favorite-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = `<i class="fas fa-check mr-2"></i>${result.message}`;
                        btn.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
                        
                        setTimeout(() => {
                            updateFavoriteButton(); // Restore proper button state
                        }, 2000);
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Failed to update favorites:', error);
                    alert('Failed to update favorites: ' + error.message);
                }
            }
            
            function updateFavoriteButton() {
                const icon = document.getElementById('favorite-icon');
                const text = document.getElementById('favorite-text');
                const btn = document.getElementById('favorite-btn');
                
                console.log('Updating favorite button, isFavorited:', isFavorited); // Debug log
                
                if (isFavorited) {
                    icon.className = 'fas fa-heart text-red-500 mr-2';
                    text.textContent = 'Remove from Favorites';
                    btn.classList.add('bg-red-50', 'text-red-500', 'border-red-200');
                    btn.classList.remove('bg-white/90', 'text-gray-700');
                } else {
                    icon.className = 'far fa-heart mr-2';
                    text.textContent = 'Add to Favorites';
                    btn.classList.remove('bg-red-50', 'text-red-500', 'border-red-200');
                    btn.classList.add('bg-white/90', 'text-gray-700');
                }
            }
            
            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM loaded, checking favorite status...'); // Debug log
                setTimeout(checkFavoriteStatus, 1000); // Wait a bit for page to fully load
            });
            
            // Also try to initialize immediately if DOM is already loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkFavoriteStatus);
            } else {
                setTimeout(checkFavoriteStatus, 1000);
            }
        })();
    </script>
</body>
</html>